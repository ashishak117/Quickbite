<!-- <div class="card mt-3">
  <div class="card-body">
    <h5>Payment</h5>
    <p>Subtotal: ₹{{ summary.subtotal }}</p>
    <p>Delivery: ₹{{ summary.delivery }}</p>
    <h4>Total: ₹{{ summary.total }}</h4>

    <div class="mb-3">
      <label>Select payment method</label>
      <select class="form-select" [(ngModel)]="paymentMethod">
        <option value="COD">Cash on Delivery</option>
        <option value="CARD">Card (Demo)</option>
      </select>
    </div>

    <button class="btn btn-primary" (click)="pay()">Pay & Generate Invoice</button>
  </div>
</div> -->
<div class="card mt-3">
  <div class="card-body">
    <h5>Payment</h5>
    <p>Subtotal: ₹{{ summary.subtotal }}</p>
    <p>Delivery: ₹{{ summary.delivery }}</p>
    <h4>Total: ₹{{ summary.total }}</h4>

    <div class="mb-3">
      <label class="form-label">Select payment method</label>
      <select class="form-select" [(ngModel)]="paymentMethod" (change)="onMethodChange()">
        <option value="COD">Cash on Delivery</option>
        <option value="CARD">Card (Demo)</option>
      </select>
    </div>

    <!-- CARD form -->
    <div *ngIf="showCardForm" class="card p-3 mb-3">
      <h6>Card details (demo)</h6>

      <form [formGroup]="cardForm" (ngSubmit)="pay()">
        <div class="mb-2">
          <label class="form-label">Cardholder name</label>
          <input formControlName="cardholder" class="form-control" [class.is-invalid]="cardForm.controls.cardholder.invalid && cardForm.controls.cardholder.touched" />
          <div *ngIf="cardForm.controls.cardholder.invalid && cardForm.controls.cardholder.touched" class="invalid-feedback">Please enter cardholder name</div>
        </div>

        <div class="mb-2">
          <label class="form-label">Card number</label>
          <input formControlName="cardNumber" class="form-control" maxlength="23"
                 (input)="cardForm.controls.cardNumber.setValue(formatCardNumber(cardForm.controls.cardNumber.value))"
                 [class.is-invalid]="cardForm.controls.cardNumber.invalid && cardForm.controls.cardNumber.touched" />
          <div *ngIf="cardForm.controls.cardNumber.errors?.invalidNumber" class="invalid-feedback">Invalid card number format</div>
          <div *ngIf="cardForm.controls.cardNumber.errors?.invalidLuhn" class="invalid-feedback">Card number failed validation</div>
        </div>

        <div class="row g-2">
          <div class="col-6">
            <label class="form-label">Expiry (MM/YY)</label>
            <input formControlName="expiry" class="form-control" placeholder="MM/YY" [class.is-invalid]="cardForm.controls.expiry.invalid && cardForm.controls.expiry.touched" />
            <div *ngIf="cardForm.controls.expiry.errors?.invalidExpiry" class="invalid-feedback">Invalid expiry</div>
            <div *ngIf="cardForm.controls.expiry.errors?.expired" class="invalid-feedback">Card expired</div>
          </div>
          <div class="col-6">
            <label class="form-label">CVC</label>
            <input formControlName="cvc" class="form-control" maxlength="4" [class.is-invalid]="cardForm.controls.cvc.invalid && cardForm.controls.cvc.touched" />
            <div *ngIf="cardForm.controls.cvc.invalid && cardForm.controls.cvc.touched" class="invalid-feedback">CVC must be 3 or 4 digits</div>
          </div>
        </div>

        <div *ngIf="cardError" class="alert alert-danger mt-2">{{ cardError }}</div>

        <div class="mt-3 d-flex gap-2">
          <button class="btn btn-primary" [disabled]="processingPayment">{{ processingPayment ? 'Processing…' : 'Pay & Generate Invoice' }}</button>
          <button type="button" class="btn btn-outline-secondary" (click)="paymentMethod='COD'; onMethodChange()">Switch to COD</button>
        </div>
      </form>
    </div>

    <!-- COD button (shown when card form hidden) -->
    <div *ngIf="!showCardForm" class="mt-2">
      <button class="btn btn-primary" (click)="pay()">Pay & Generate Invoice</button>
    </div>
  </div>
</div>
